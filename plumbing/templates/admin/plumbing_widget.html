{% load i18n %}
<div id="plumbing" class="plumbing" ng-app="plumbing" ng-controller="graph">

    <div class="toolbox">
        <div class="btn" ng-click="addNode('page')" id="lookup_{% verbatim %}{{ current_noderef }}{% endverbatim %}">{% trans 'Add page' %}</div>
        <div class="btn" ng-click="addNode('email')" id="lookup_{% verbatim %}{{ current_noderef }}{% endverbatim %}">{% trans 'Add email' %}</div>
        <div class="btn" ng-click="addNode('sms')" id="lookup_{% verbatim %}{{ current_noderef }}{% endverbatim %}">{% trans 'Add sms' %}</div>
        <div class="btn" ng-click="addNode('delay')" id="lookup_{% verbatim %}{{ current_noderef }}{% endverbatim %}">{% trans 'Add delay' %}</div>
    </div>

    <ul class="variables">
        <p><strong>{% trans 'Available variables' %}</strong></p>
        <li class="variable" ng-repeat="variable in variables track by $index">{% verbatim %}{{ variable }}{% endverbatim %}</li>
    </ul>

    <div class="floatbox"></div>

    <div class="node box" ng-class="node.type" ng-repeat="node in data.nodes track by $index" ng-style="node.metrics" ng-model="data.nodes">
        <span ng-if="node.type == 'email'">
            <i class="icon-envelope icon-alpha5"></i>
        </span>
        <span ng-if="node.type == 'sms'">
            <i class="icon-comment icon-alpha5"></i>
        </span>
        <span ng-if="node.type == 'delay'">
            <i class="icon-time icon-alpha5"></i>
        </span>

        {% verbatim %}
        {{ node.title }}
        <span ng-if="node.type == 'delay'">
            t + {{ node.delay.number }} {{ node.delay.unit }}
        </span>
        <div class="ep"></div>
        <div class="delete" ng-click="deleteNode($index)" ng-hide="node.id == 0">×</div>
        <input type="hidden" class="noderef" id="noderef_{{ node.id }}" value="{{ node.ref_id }}">
        {% endverbatim %}

        <div ng-if="node.type == 'delay'" class="settings box" ng-show="showDelay == $index">
            <div class="close" ng-click="close()">×</div>
            <input type="number" placeholder="{% trans 'Number' %}" ng-model="node.delay.number">
            <select ng-model="node.delay.unit">
                <option value="minutes"> {% trans 'minutes' %} </option>
                <option value="hours"> {% trans 'hours' %} </option>
            </select>
        </div>
    </div>

    <div class="edge" ng-repeat="edge in data.edges track by $index" ng-model="data.edges">

        <div class="overlay box">
            <div class="summary" ng-repeat="condition in edge.conditions track by $index">
                {% verbatim %}{{ condition.var_name }}{% endverbatim %}
                <span ng-switch="condition.operator">
                    <span ng-switch-when="eq"> = </span>
                    <span ng-switch-when="ne"> &ne; </span>
                    <span ng-switch-when="lt"> &lt; </span>
                    <span ng-switch-when="le"> &le; </span>
                    <span ng-switch-when="gt"> &gt; </span>
                    <span ng-switch-when="ge"> &ge; </span>
                    <span ng-switch-when="in"> {% trans 'contains' %} </span>
                </span>
                {% verbatim %}{{ condition.value }}{% endverbatim %}
            </div>
            <div class="summary" ng-show="!edge.conditions.length">
                {% trans 'Pass' %}
            </div>
            <div class="delete" ng-click="deleteEdge($index)">×</div>
        </div>

        <div class="conditions box" ng-show="showConditions == $index">
            <div class="close" ng-click="close()">×</div>
            <div class="condition" ng-repeat="condition in edge.conditions track by $index">
                <input type="text" placeholder="{% trans 'Variable name' %}" ng-model="condition.var_name">
                <select ng-model="condition.operator">
                    <option value="eq"> = </option>
                    <option value="ne"> &ne; </option>
                    <option value="lt"> &lt; </option>
                    <option value="le"> &le; </option>
                    <option value="gt"> &gt; </option>
                    <option value="ge"> &ge; </option>
                    <option value="in"> {% trans 'contains' %} </option>
                </select>
                <input type="text" placeholder="{% trans 'Value' %}" ng-model="condition.value">
                <a class="trash" ng-click="deleteCondition($index)"><i class="icon-trash icon-alpha5"></i></a>
            </div>
            <div class="btn" ng-click="addCondition()">{% trans 'Add condition' %}</div>
        </div>

    </div>

    <textarea name="data" class="data ng-hide">{% verbatim %}{{ data }}{% endverbatim %}</textarea>
</div>

<script>
    var initData = {{ value|safe }};
    var initVars = {{ vars|safe }};
    var adminUrl = '{{ admin_url }}';
    var nodeApiUrl = '{{ node_api }}';
</script>
